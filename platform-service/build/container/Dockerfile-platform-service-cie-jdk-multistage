# Copyright 2022 Harness Inc. All rights reserved.
# Use of this source code is governed by the PolyForm Free Trial 1.0.0 license
# that can be found in the licenses directory at the root of this repository, also available at
# https://polyformproject.org/wp-content/uploads/2020/05/PolyForm-Free-Trial-1.0.0.txt.

FROM us.gcr.io/platform-205701/cie-agent-harness-core-jdk11:latest as builder

RUN mkdir -p /app

COPY . /app

WORKDIR /app

ENV BUILD_PURPOSE=DEVELOPMENT
ENV LC_CTYPE=C.UTF-8

RUN chmod +x /app/platform-service/build/feature_build.sh
RUN chmod +x /app/platform-service/build/build_jar.sh
RUN chmod +x /app/platform-service/build/build_dist.sh
RUN chmod +x /app/scripts/bazel/testDistribute.sh
RUN chmod +x /app/scripts/bazel/generate_credentials.sh

RUN /app/scripts/bazel/generate_credentials.sh
RUN bazel version
RUN bazel clean
RUN /app/platform-service/build/feature_build.sh
RUN /app/platform-service/build/build_jar.sh
RUN /app/platform-service/build/build_dist.sh

FROM us.gcr.io/platform-205701/ubi/ubi-java:8.8 as base

# Add the capsule JAR and config.yml
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/platform-service-capsule.jar /opt/harness/
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/keystore.jks /opt/harness/
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/config.yml /opt/harness/
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/classpath_metadata.json /opt/harness/

COPY --chown=65534:65534  --from=builder /app/dist/platform-service/scripts /opt/harness
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/default.jfc /opt/harness/
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/profile.jfc /opt/harness/
COPY --chown=65534:65534  --from=builder /app/dist/platform-service/profile.jfc /opt/harness/
COPY --chown=65534:65534 --from=builder /app/dockerization/base-images/apm/*.sh /opt/harness

RUN chmod +x /opt/harness/*.sh
CMD [ "/opt/harness/run.sh" ]

############################ON PREM#########################
FROM base as onprem

RUN /opt/harness/inject-onprem-apm-bins-into-dockerimage.sh && rm /opt/harness/inject-onprem-apm-bins-into-dockerimage.sh
USER root
RUN microdnf remove tar unzip gzip
USER 65534


############################SAAS#########################
FROM base as saas

RUN /opt/harness/inject-saas-apm-bins-into-dockerimage.sh && rm -rf /opt/harness/inject-saas-apm-bins-into-dockerimage.sh

USER root