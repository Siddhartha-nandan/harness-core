apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "access-control.name" . }}
  namespace: '{{ .Release.Namespace }}'
  labels:
    {{- if .Values.global.commonLabels }}
    {{- include "harnesscommon.tplvalues.render" ( dict "value" .Values.global.commonLabels "context" $ ) | nindent 4 }}
    {{- end }}
  {{- if .Values.global.commonAnnotations }}
  annotations: {{- include "harnesscommon.tplvalues.render" ( dict "value" .Values.global.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
data:
  DEPLOY_MODE: '{{ .Values.config.DEPLOY_MODE }}'
  LOGGING_LEVEL: '{{ .Values.config.LOGGING_LEVEL }}'
  EVENTS_CONFIG_USE_SENTINEL: '{{ .Values.global.database.redis.installed }}'
  EVENTS_CONFIG_SENTINEL_MASTER_NAME: 'harness-redis'
  EVENTS_CONFIG_REDIS_SENTINELS: {{ include "harnesscommon.dbconnectionv2.redisConnection" (dict "context" $) }}
  EVENTS_CONFIG_REDIS_URL: {{ include "harnesscommon.dbconnectionv2.redisConnection" (dict "context" $) }}
  LOCK_CONFIG_USE_SENTINEL: '{{ .Values.global.database.redis.installed }}'
  LOCK_CONFIG_SENTINEL_MASTER_NAME: 'harness-redis'
  LOCK_CONFIG_REDIS_SENTINELS: {{ include "harnesscommon.dbconnectionv2.redisConnection" (dict "context" $) }}
  LOCK_CONFIG_REDIS_URL: {{ include "harnesscommon.dbconnectionv2.redisConnection" (dict "context" $) }}
  RESOURCE_GROUP_ITERATOR_ENABLED: '{{ .Values.config.RESOURCE_GROUP_ITERATOR_ENABLED }}'
  RESOURCE_GROUP_ITERATOR_INTERVAL: '{{ .Values.config.RESOURCE_GROUP_ITERATOR_INTERVAL }}'
  USER_GROUP_ITERATOR_ENABLED: '{{ .Values.config.USER_GROUP_ITERATOR_ENABLED }}'
  USER_GROUP_ITERATOR_INTERVAL: '{{ .Values.config.USER_GROUP_ITERATOR_INTERVAL }}'
  USER_ITERATOR_ENABLED: '{{ .Values.config.USER_ITERATOR_ENABLED }}'
  USER_ITERATOR_INTERVAL: '{{ .Values.config.USER_ITERATOR_INTERVAL }}'
  SERVICEACCOUNT_ITERATOR_ENABLED: '{{ .Values.config.SERVICEACCOUNT_ITERATOR_ENABLED }}'
  SERVICEACCOUNT_ITERATOR_INTERVAL: '{{ .Values.config.SERVICEACCOUNT_ITERATOR_INTERVAL }}'
  SUPPORTPREFERENCE_ITERATOR_ENABLED: '{{ .Values.config.SUPPORTPREFERENCE_ITERATOR_ENABLED }}'
  SUPPORTPREFERENCE_ITERATOR_INTERVAL: '{{ .Values.config.SUPPORTPREFERENCE_ITERATOR_INTERVAL }}'
  SCOPE_ITERATOR_ENABLED: '{{ .Values.config.SCOPE_ITERATOR_ENABLED }}'
  SCOPE_ITERATOR_INTERVAL: '{{ .Values.config.SCOPE_ITERATOR_INTERVAL }}'
  RESOURCE_GROUP_CLIENT_BASE_URL: {{ .Values.config.RESOURCE_GROUP_CLIENT_BASE_URL | default "http://platform-service:9005/api/" }}
  USER_CLIENT_BASE_URL: {{ .Values.config.USER_CLIENT_BASE_URL | default "http://ng-manager:7090/" }}
  USER_GROUP_CLIENT_BASE_URL: {{ .Values.config.USER_GROUP_CLIENT_BASE_URL | default "http://ng-manager:7090/" }}
  SERVICEACCOUNT_CLIENT_BASE_URL: {{ .Values.config.SERVICEACCOUNT_CLIENT_BASE_URL | default "http://ng-manager:7090/" }}
  ACCOUNT_CLIENT_BASE_URL: {{ .Values.config.ACCOUNT_CLIENT_BASE_URL | default "http://harness-manager:9090/api/" }}
  FEATURE_FLAG_CLIENT_BASE_URL: {{ .Values.config.FEATURE_FLAG_CLIENT_BASE_URL | default "http://harness-manager:9090/api/" }}
  PROJECT_CLIENT_BASE_URL: {{ .Values.config.PROJECT_CLIENT_BASE_URL | default "http://ng-manager:7090/" }}
  ORGANIZATION_CLIENT_BASE_URL: {{ .Values.config.ORGANIZATION_CLIENT_BASE_URL | default "http://ng-manager:7090/" }}
  OFFSET_FLUSH_INTERVAL_MS: '{{ .Values.config.OFFSET_FLUSH_INTERVAL_MS }}'
  MONGODB_SSL_ENABLED: '{{ .Values.mongoSSL.enabled }}'
  AGGREGATOR_ENABLED: '{{ .Values.config.AGGREGATOR_ENABLED }}'
  ENABLE_AUTH: '{{ .Values.config.ENABLE_AUTH }}'
  ACCESS_CONTROL_PREFERENCE_ENABLED: '{{ .Values.config.ACCESS_CONTROL_PREFERENCE_ENABLED }}'
  NOTIFICATION_SLACK_WEBHOOK_URL: '{{ .Values.config.NOTIFICATION_SLACK_WEBHOOK_URL }}'
  NOTIFICATION_ENVIRONMENT: '{{ .Values.config.NOTIFICATION_ENVIRONMENT }}'
  ENABLE_ACCESS_CONTROL: '{{ .Values.config.ENABLE_ACCESS_CONTROL }}'
  ACCESS_CONTROL_SERVICE_BASE_URL: {{ .Values.config.ACCESS_CONTROL_SERVICE_BASE_URL | default "http://access-control:9006/api/" }}
  ENABLE_AUDIT: '{{ .Values.config.ENABLE_AUDIT }}'
  AUDIT_CLIENT_BASE_URL: {{ .Values.config.AUDIT_CLIENT_BASE_URL | default "http://platform-service:9005/api/" }}
  DISTRIBUTED_LOCK_IMPLEMENTATION: '{{ .Values.config.DISTRIBUTED_LOCK_IMPLEMENTATION }}'
  GOOGLE_APPLICATION_CREDENTIALS: '{{ .Values.config.GOOGLE_APPLICATION_CREDENTIALS }}'
  MEMORY: {{ .Values.java.memory | default "512m" }}
  STACK_DRIVER_LOGGING_ENABLED: '{{ .Values.global.stackDriverLoggingEnabled }}'
  {{ include "harnesscommon.harnessfunctions.java17flags" (dict "context" $) | nindent 2 }}
  # Additional configs
  {{- if .Values.additionalConfigs }}
  {{- toYaml .Values.additionalConfigs | nindent 2 }}
  {{- end }}
  {{- include "harnesscommon.monitoring.config" . | nindent 2 }}
  {{- if ne .Values.config.DEPLOY_MODE "KUBERNETES_ONPREM" }}
#  APPD related configs are commented out. We can add them back if needed
#  APPDYNAMICS_AGENT_ACCOUNT_NAME: {{ .Values.config.APPDYNAMICS_AGENT_ACCOUNT_NAME | quote }}
#  APPDYNAMICS_AGENT_APPLICATION_NAME: {{ .Values.config.APPDYNAMICS_AGENT_APPLICATION_NAME | quote }}
#  APPDYNAMICS_AGENT_TIER_NAME: {{ .Values.config.APPDYNAMICS_AGENT_TIER_NAME | quote }}
#  APPDYNAMICS_CONTROLLER_HOST_NAME: {{ .Values.config.APPDYNAMICS_CONTROLLER_HOST_NAME | quote }}
#  APPDYNAMICS_CONTROLLER_PORT: {{ .Values.config.APPDYNAMICS_CONTROLLER_PORT | quote }}
#  APPDYNAMICS_CONTROLLER_SSL_ENABLED: {{ .Values.config.APPDYNAMICS_CONTROLLER_SSL_ENABLED | quote }}
  BASE_PATH_PREFIX: {{ .Values.config.BASE_PATH_PREFIX | quote }}
  BATCH_SIZE_FOR_ACL_CREATION: {{ .Values.config.BATCH_SIZE_FOR_ACL_CREATION | quote }}
  CF_CLIENT_ANALYTICS_ENABLED: {{ .Values.config.CF_CLIENT_ANALYTICS_ENABLED | quote }}
  CF_CLIENT_BUFFER_SIZE: {{ .Values.config.CF_CLIENT_BUFFER_SIZE | quote }}
  CF_CLIENT_CONFIG_URL: {{ .Values.config.CF_CLIENT_CONFIG_URL | quote }}
  CF_CLIENT_CONNECTION_TIMEOUT: {{ .Values.config.CF_CLIENT_CONNECTION_TIMEOUT | quote }}
  CF_CLIENT_EVENT_URL: {{ .Values.config.CF_CLIENT_EVENT_URL | quote }}
  CF_CLIENT_READ_TIMEOUT: {{ .Values.config.CF_CLIENT_READ_TIMEOUT | quote }}
  CF_RETRIES: {{ .Values.config.CF_RETRIES | quote }}
  CF_SLEEP_INTERVAL: {{ .Values.config.CF_SLEEP_INTERVAL | quote }}
  COLLECTION_INCLUDE_LIST: {{ .Values.config.COLLECTION_INCLUDE_LIST | quote }}
  DATABASE_INCLUDE_LIST: {{ .Values.config.DATABASE_INCLUDE_LIST | quote }}
  DISABLE_REDUNDANT_ACLS: {{ .Values.config.DISABLE_REDUNDANT_ACLS | quote }}
  ENABLE_ACL_PROCESSING_THROUGH_OUTBOX: {{ .Values.config.ENABLE_ACL_PROCESSING_THROUGH_OUTBOX | quote }}
#  ENABLE_APPDYNAMICS: {{ .Values.config.ENABLE_APPDYNAMICS | quote }}
  ENABLE_HTTP_LOGGING: {{ .Values.config.ENABLE_HTTP_LOGGING | quote }}
  ENABLE_OPENTELEMETRY: {{ .Values.config.ENABLE_OPENTELEMETRY | quote }}
  ENABLE_PARALLEL_PROCESSING_OF_USERGROUP_UPDATES: {{ .Values.config.ENABLE_PARALLEL_PROCESSING_OF_USERGROUP_UPDATES | quote }}
  ENFORCEMENT_CHECK_ENABLED: {{ .Values.config.ENFORCEMENT_CHECK_ENABLED | quote }}
  ENV: {{ .Values.config.ENV | quote }}
  EVENTS_CONFIG_CONSUMER_THREADS: {{ .Values.config.EVENTS_CONFIG_CONSUMER_THREADS | quote }}
  EVENTS_CONFIG_ENV_NAMESPACE: {{ .Values.config.EVENTS_CONFIG_ENV_NAMESPACE | quote }}
  EVENTS_CONFIG_REDIS_SSL_CA_TRUST_STORE_PATH: {{ .Values.config.EVENTS_CONFIG_REDIS_SSL_CA_TRUST_STORE_PATH | quote }}
  EVENTS_CONFIG_REDIS_SSL_ENABLED: {{ .Values.config.EVENTS_CONFIG_REDIS_SSL_ENABLED | quote }}
  EVENTS_CONFIG_REDIS_USERNAME: {{ .Values.config.EVENTS_CONFIG_REDIS_USERNAME | quote }}
  EXPORT_METRICS_TO_STACK_DRIVER: {{ .Values.config.EXPORT_METRICS_TO_STACK_DRIVER | quote }}
  FEATURE_FLAG_SYSTEM: {{ .Values.config.FEATURE_FLAG_SYSTEM | quote }}
  JAVA_ADVANCED_FLAGS: {{ .Values.config.JAVA_ADVANCED_FLAGS | quote }}
  LOCK_CONFIG_ENV_NAMESPACE: {{ .Values.config.LOCK_CONFIG_ENV_NAMESPACE | quote }}
  LOCK_CONFIG_REDIS_USERNAME: {{ .Values.config.LOCK_CONFIG_REDIS_USERNAME | quote }}
  LOGGERS: {{ .Values.config.LOGGERS | quote }}
  MAX_STREAM_BATCH_SIZE: {{ .Values.config.MAX_STREAM_BATCH_SIZE | quote }}
  MONGO_MAX_OPERATION_TIME_IN_MILLIS: {{ .Values.config.MONGO_MAX_OPERATION_TIME_IN_MILLIS | quote }}
  NAMESPACE: {{ .Values.config.NAMESPACE | quote }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.config.OTEL_EXPORTER_OTLP_ENDPOINT | quote }}
  OTEL_SERVICE_NAME: {{ .Values.config.OTEL_SERVICE_NAME | quote }}
  SEGMENT_ENABLED: {{ .Values.config.SEGMENT_ENABLED | quote }}
  SYNC_FEATURES_TO_CF: {{ .Values.config.SYNC_FEATURES_TO_CF | quote }}
  USE_WORKLOAD_IDENTITY: {{ .Values.config.USE_WORKLOAD_IDENTITY | quote }}
  {{- end }}
