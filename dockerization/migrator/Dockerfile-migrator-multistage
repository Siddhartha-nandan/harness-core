# Copyright 2022 Harness Inc. All rights reserved.
# Use of this source code is governed by the PolyForm Free Trial 1.0.0 license
# that can be found in the licenses directory at the root of this repository, also available at
# https://polyformproject.org/wp-content/uploads/2020/05/PolyForm-Free-Trial-1.0.0.txt.

# to be used when building in Jenkins

FROM us.gcr.io/platform-205701/cie-agent-harness-core-jdk11:latest as builder

RUN mkdir -p /app
ARG GCP_KEY
ENV SERVICE_NAME="migrator"
COPY . /app
WORKDIR /app

ENV BUILD_PURPOSE=DEVELOPMENT

RUN chmod +x \
 /app/build/feature_build.sh \
 /app/scripts/bazel/generate_credentials.sh \
 && /app/scripts/bazel/generate_credentials.sh \
 && /app/build/feature_build.sh $GCP_KEY

FROM us.gcr.io/platform-205701/ubi/ubi-java:8.8 as base

# Add the capsule JAR and config.yml
COPY --chown=65534:65534 --from=builder \
  /app/dist/migrator/migrator-capsule.jar \
  /app/dist/migrator/newrelic.yml \
  /app/dist/migrator/keystore.jks \
  /app/dist/migrator/config.yml \
  /app/dist/migrator/redisson-jcache.yaml \
  /app/dist/migrator/protocol.info \
  /app/dist/migrator/default.jfc \
  /app/dist/migrator/profile.jfc \
  /app/dist/migrator/scripts \
  /app/dockerization/base-images/apm/*.sh \
  /opt/harness/

USER root

RUN microdnf install -y yum \
    && yum -y install fontconfig dejavu-sans-fonts wget \
    && chmod +x /usr/bin/yq \
    && chmod +x /opt/harness/*.sh

WORKDIR /opt/harness
USER 65534
CMD [ "./run.sh" ]